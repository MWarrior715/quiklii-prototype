#!/usr/bin/env node

/**
 * Script para descargar im√°genes de Unsplash y crear productos para restaurantes
 * Automatiza la descarga de im√°genes y la creaci√≥n de productos/menu items
 */

import https from 'https';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import { dirname } from 'path';
import { sequelize } from '../src/config/database.js';
import { Restaurant } from '../src/models/Restaurant.js';
import { MenuItem } from '../src/models/MenuItem.js';

// Obtener __dirname en m√≥dulos ES
const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// Configuraci√≥n de Unsplash (API p√∫blica - no requiere API key para b√∫squedas b√°sicas)
const UNSPLASH_BASE_URL = 'https://source.unsplash.com/800x600/?';
const RESTAURANT_IMAGE_SIZE = '1200x800';
const PRODUCT_IMAGE_SIZE = '800x800';

// Categor√≠as de comida por tipo de restaurante
const FOOD_CATEGORIES = {
  'Italiana': ['Pizza', 'Pasta', 'Risotto', 'Lasagna', 'Tiramisu', 'Gelato'],
  'Japonesa': ['Sushi', 'Sashimi', 'Ramen', 'Tempura', 'Miso Soup', 'Onigiri'],
  'Colombiana': ['Bandeja Paisa', 'Sancocho', 'Arepas', 'Empanadas', 'Chicharr√≥n', 'Pl√°tano'],
  'Saludable': ['Bowl', 'Ensalada', 'Smoothie', 'Wrap', 'Sopa', 'Quinoa'],
  'Americana': ['Hamburguesa', 'Hot Dog', 'Papas Fritas', 'Chicken Wings', 'BBQ', 'Sandwich'],
  'China': ['Wok', 'Dim Sum', 'Arroz Frito', 'Spring Rolls', 'Pato', 'Szechuan'],
  'Internacional': ['C√≥cteles', 'Tapas', 'Queso', 'Charcuter√≠a', 'Vino', 'Cerveza']
};

// Productos por tipo de restaurante
const RESTAURANT_PRODUCTS = {
  'Bella Italia': [
    { name: 'Pizza Quattro Stagioni', category: 'Pizza', price: 32000, description: 'Pizza con jam√≥n, champi√±ones, alcachofas y aceitunas' },
    { name: 'Fettuccine Alfredo', category: 'Pasta', price: 28000, description: 'Pasta casera con salsa Alfredo cremosa y parmesano' }
  ],
  'Sakura Sushi': [
    { name: 'Nigiri de At√∫n', category: 'Sushi', price: 18000, description: 'Arroz con at√∫n fresco sobre alga nori' },
    { name: 'Miso Ramen', category: 'Sopa', price: 25000, description: 'Sopa de fideos con caldo de miso y vegetales' }
  ],
  'El Rinc√≥n Paisa': [
    { name: 'Mondongo', category: 'Sopa', price: 20000, description: 'Sopa tradicional de mondongo con guarnici√≥n' },
    { name: 'Chuleta Valluna', category: 'Carne', price: 35000, description: 'Chuleta de cerdo apanada con yuca y ensalada' }
  ],
  'Green Garden': [
    { name: 'Ensalada Caesar', category: 'Ensalada', price: 22000, description: 'Lechuga romana, crutones, parmesano y aderezo Caesar' },
    { name: 'Wrap de Pollo', category: 'Wrap', price: 26000, description: 'Wrap integral con pollo grillado y vegetales' }
  ],
  'Burger Master': [
    { name: 'Burger BBQ Bacon', category: 'Hamburguesa', price: 22000, description: 'Hamburguesa con bacon, queso cheddar y salsa BBQ' },
    { name: 'Chicken Crispy', category: 'Pollo', price: 19000, description: 'Pechuga de pollo crujiente con papas fritas' }
  ],
  'Dragon Wok': [
    { name: 'Wok de Pollo', category: 'Wok', price: 24000, description: 'Pollo salteado con vegetales y fideos chinos' },
    { name: 'Arroz Tres Delicias', category: 'Arroz', price: 18000, description: 'Arroz frito con huevo, jam√≥n y camarones' }
  ],
  'La Noche Bar': [
    { name: 'C√≥ctel Mojito', category: 'C√≥ctel', price: 15000, description: 'C√≥ctel cl√°sico con ron, menta y lima' },
    { name: 'Tabla de Quesos', category: 'Tapas', price: 28000, description: 'Selecci√≥n de quesos artesanales con frutas y nueces' }
  ]
};

// Funci√≥n para descargar imagen desde URL
async function downloadImage(url, filename) {
  return new Promise((resolve, reject) => {
    const file = fs.createWriteStream(filename);
    
    https.get(url, (response) => {
      if (response.statusCode === 200) {
        response.pipe(file);
        file.on('finish', () => {
          file.close();
          console.log(`‚úÖ Imagen descargada: ${filename}`);
          resolve(filename);
        });
      } else {
        file.close();
        fs.unlinkSync(filename);
        reject(new Error(`Error al descargar imagen: ${response.statusCode}`));
      }
    }).on('error', (err) => {
      fs.unlinkSync(filename);
      reject(err);
    });
  });
}

// Funci√≥n para obtener imagen de Unsplash basada en b√∫squeda
function getUnsplashImageUrl(query, size = PRODUCT_IMAGE_SIZE) {
  const searchQuery = encodeURIComponent(query);
  return `https://source.unsplash.com/${size}/?${searchQuery},food`;
}

// Funci√≥n para crear directorios necesarios
function createDirectories() {
  const directories = [
    path.join(__dirname, '../uploads/images/restaurants'),
    path.join(__dirname, '../uploads/images/products'),
    path.join(__dirname, '../uploads/images/temp')
  ];
  
  directories.forEach(dir => {
    if (!fs.existsSync(dir)) {
      fs.mkdirSync(dir, { recursive: true });
      console.log(`üìÅ Directorio creado: ${dir}`);
    }
  });
}

// Funci√≥n para descargar imagen de restaurante
async function downloadRestaurantImage(restaurantName, restaurantId) {
  const searchTerms = restaurantName.toLowerCase().replace(/\s+/g, '-');
  const imageUrl = getUnsplashImageUrl(searchTerms, RESTAURANT_IMAGE_SIZE);
  const filename = `restaurant-${restaurantId}-${Date.now()}.jpg`;
  const filepath = path.join(__dirname, '../uploads/images/restaurants', filename);
  
  try {
    await downloadImage(imageUrl, filepath);
    return `/uploads/images/restaurants/${filename}`;
  } catch (error) {
    console.error(`‚ùå Error descargando imagen para restaurante ${restaurantName}:`, error.message);
    return null;
  }
}

// Funci√≥n para descargar imagen de producto
async function downloadProductImage(productName, category, restaurantId, productIndex) {
  const searchTerms = `${category},${productName}`;
  const imageUrl = getUnsplashImageUrl(searchTerms, PRODUCT_IMAGE_SIZE);
  const filename = `product-${restaurantId}-${productIndex}-${Date.now()}.jpg`;
  const filepath = path.join(__dirname, '../uploads/images/products', filename);
  
  try {
    await downloadImage(imageUrl, filepath);
    return `/uploads/images/products/${filename}`;
  } catch (error) {
    console.error(`‚ùå Error descargando imagen para producto ${productName}:`, error.message);
    return null;
  }
}

// Funci√≥n para crear productos para un restaurante
async function createRestaurantProducts(restaurant, products) {
  const createdProducts = [];
  
  for (let i = 0; i < products.length; i++) {
    const product = products[i];
    
    console.log(`üì∏ Descargando imagen para producto: ${product.name}`);
    const imageUrl = await downloadProductImage(
      product.name, 
      product.category, 
      restaurant.id, 
      i + 1
    );
    
    try {
      const menuItem = await MenuItem.create({
        name: product.name,
        description: product.description,
        price: product.price,
        image: imageUrl,
        category: product.category,
        restaurantId: restaurant.id,
        available: true,
        preparationTime: Math.floor(Math.random() * 20) + 10, // 10-30 minutos
        isVegetarian: product.category.toLowerCase().includes('ensalada') || 
                     product.category.toLowerCase().includes('vegetal') ||
                     product.name.toLowerCase().includes('vegetariano'),
        isSpicy: product.name.toLowerCase().includes('picante') || 
                product.description.toLowerCase().includes('picante')
      });
      
      createdProducts.push(menuItem);
      console.log(`‚úÖ Producto creado: ${product.name} para ${restaurant.name}`);
    } catch (error) {
      console.error(`‚ùå Error creando producto ${product.name}:`, error.message);
    }
  }
  
  return createdProducts;
}

// Funci√≥n principal
async function main() {
  console.log('üöÄ Iniciando script de descarga de im√°genes y creaci√≥n de productos...\n');
  
  try {
    // Conectar a la base de datos
    console.log('üîó Conectando a la base de datos...');
    await sequelize.authenticate();
    console.log('‚úÖ Conexi√≥n a base de datos establecida');
    
    // Crear directorios necesarios
    createDirectories();
    
    // Obtener todos los restaurantes
    console.log('\nüè™ Obteniendo restaurantes existentes...');
    const restaurants = await Restaurant.findAll();
    console.log(`üìä Se encontraron ${restaurants.length} restaurantes`);
    
    // Procesar cada restaurante
    for (const restaurant of restaurants) {
      console.log(`\nüçΩÔ∏è Procesando restaurante: ${restaurant.name}`);
      
      // Descargar imagen de restaurante si no tiene una
      if (!restaurant.imageUrl) {
        console.log(`üì∏ Descargando imagen para restaurante: ${restaurant.name}`);
        const restaurantImageUrl = await downloadRestaurantImage(restaurant.name, restaurant.id);
        
        if (restaurantImageUrl) {
          await restaurant.update({ imageUrl: restaurantImageUrl });
          console.log(`‚úÖ Imagen de restaurante actualizada: ${restaurant.name}`);
        }
      }
      
      // Verificar si el restaurante ya tiene productos
      const existingProducts = await MenuItem.findAll({
        where: { restaurantId: restaurant.id }
      });
      
      console.log(`üì¶ El restaurante ${restaurant.name} tiene ${existingProducts.length} productos existentes`);
      
      // Si el restaurante tiene menos de 2 productos, crear nuevos
      if (existingProducts.length < 2) {
        const productsToCreate = RESTAURANT_PRODUCTS[restaurant.name] || 
                               RESTAURANT_PRODUCTS[Object.keys(RESTAURANT_PRODUCTS)[0]];
        
        const productsNeeded = 2 - existingProducts.length;
        const productsToAdd = productsToCreate.slice(0, productsNeeded);
        
        if (productsToAdd.length > 0) {
          console.log(`üõçÔ∏è Creando ${productsToAdd.length} productos para ${restaurant.name}...`);
          await createRestaurantProducts(restaurant, productsToAdd);
        }
      } else {
        console.log(`‚úÖ El restaurante ${restaurant.name} ya tiene suficientes productos`);
      }
    }
    
    console.log('\nüéâ ¬°Proceso completado exitosamente!');
    console.log('‚úÖ Todas las im√°genes han sido descargadas');
    console.log('‚úÖ Todos los productos han sido creados');
    
  } catch (error) {
    console.error('‚ùå Error en el proceso:', error);
  } finally {
    await sequelize.close();
    console.log('\nüîí Conexi√≥n a base de datos cerrada');
  }
}

// Ejecutar el script
if (import.meta.url === `file://${process.argv[1]}`) {
  main().catch(console.error);
}

export { downloadImage, getUnsplashImageUrl, createRestaurantProducts };